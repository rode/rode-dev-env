var ce=Object.defineProperty;var V=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,ae=Object.prototype.propertyIsEnumerable;var q=(e,t,n)=>t in e?ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,w=(e,t)=>{for(var n in t||(t={}))ue.call(t,n)&&q(e,n,t[n]);if(V)for(var n of V(t))ae.call(t,n)&&q(e,n,t[n]);return e};var ut=typeof require!="undefined"?require:e=>{throw new Error('Dynamic require of "'+e+'" is not supported')};var l=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var _=l(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.toCommandProperties=m.toCommandValue=void 0;function le(e){return e==null?"":typeof e=="string"||e instanceof String?e:JSON.stringify(e)}m.toCommandValue=le;function fe(e){return Object.keys(e).length?{title:e.title,line:e.startLine,endLine:e.endLine,col:e.startColumn,endColumn:e.endColumn}:{}}m.toCommandProperties=fe});var R=l(s=>{"use strict";var de=s&&s.__createBinding||(Object.create?function(e,t,n,o){o===void 0&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){o===void 0&&(o=n),e[o]=t[n]}),pe=s&&s.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),me=s&&s.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!=="default"&&Object.hasOwnProperty.call(e,n)&&de(t,e,n);return pe(t,e),t};Object.defineProperty(s,"__esModule",{value:!0});s.issue=s.issueCommand=void 0;var he=me(require("os")),T=_();function j(e,t,n){let o=new M(e,t,n);process.stdout.write(o.toString()+he.EOL)}s.issueCommand=j;function ge(e,t=""){j(e,{},t)}s.issue=ge;var D="::",M=class{constructor(t,n,o){t||(t="missing.command"),this.command=t,this.properties=n,this.message=o}toString(){let t=D+this.command;if(this.properties&&Object.keys(this.properties).length>0){t+=" ";let n=!0;for(let o in this.properties)if(this.properties.hasOwnProperty(o)){let i=this.properties[o];i&&(n?n=!1:t+=",",t+=`${o}=${ve(i)}`)}}return t+=`${D}${_e(this.message)}`,t}};function _e(e){return T.toCommandValue(e).replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A")}function ve(e){return T.toCommandValue(e).replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A").replace(/:/g,"%3A").replace(/,/g,"%2C")}});var G=l(a=>{"use strict";var Ce=a&&a.__createBinding||(Object.create?function(e,t,n,o){o===void 0&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){o===void 0&&(o=n),e[o]=t[n]}),Se=a&&a.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),F=a&&a.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!=="default"&&Object.hasOwnProperty.call(e,n)&&Ce(t,e,n);return Se(t,e),t};Object.defineProperty(a,"__esModule",{value:!0});a.issueCommand=void 0;var N=F(require("fs")),Oe=F(require("os")),be=_();function Ee(e,t){let n=process.env[`GITHUB_${e}`];if(!n)throw new Error(`Unable to find environment variable for file command ${e}`);if(!N.existsSync(n))throw new Error(`Missing file at path: ${n}`);N.appendFileSync(n,`${be.toCommandValue(t)}${Oe.EOL}`,{encoding:"utf8"})}a.issueCommand=Ee});var h=l(r=>{"use strict";var ye=r&&r.__createBinding||(Object.create?function(e,t,n,o){o===void 0&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){o===void 0&&(o=n),e[o]=t[n]}),we=r&&r.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),H=r&&r.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!=="default"&&Object.hasOwnProperty.call(e,n)&&ye(t,e,n);return we(t,e),t},Ie=r&&r.__awaiter||function(e,t,n,o){function i(u){return u instanceof n?u:new n(function(p){p(u)})}return new(n||(n=Promise))(function(u,p){function ie(f){try{E(o.next(f))}catch(y){p(y)}}function se(f){try{E(o.throw(f))}catch(y){p(y)}}function E(f){f.done?u(f.value):i(f.value).then(ie,se)}E((o=o.apply(e,t||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0});r.getState=r.saveState=r.group=r.endGroup=r.startGroup=r.info=r.notice=r.warning=r.error=r.debug=r.isDebug=r.setFailed=r.setCommandEcho=r.setOutput=r.getBooleanInput=r.getMultilineInput=r.getInput=r.addPath=r.setSecret=r.exportVariable=r.ExitCode=void 0;var c=R(),U=G(),v=_(),C=H(require("os")),$e=H(require("path")),B;(function(e){e[e.Success=0]="Success",e[e.Failure=1]="Failure"})(B=r.ExitCode||(r.ExitCode={}));function Pe(e,t){let n=v.toCommandValue(t);if(process.env[e]=n,process.env.GITHUB_ENV||""){let i="_GitHubActionsFileCommandDelimeter_",u=`${e}<<${i}${C.EOL}${n}${C.EOL}${i}`;U.issueCommand("ENV",u)}else c.issueCommand("set-env",{name:e},n)}r.exportVariable=Pe;function Ae(e){c.issueCommand("add-mask",{},e)}r.setSecret=Ae;function Ve(e){process.env.GITHUB_PATH||""?U.issueCommand("PATH",e):c.issueCommand("add-path",{},e),process.env.PATH=`${e}${$e.delimiter}${process.env.PATH}`}r.addPath=Ve;function I(e,t){let n=process.env[`INPUT_${e.replace(/ /g,"_").toUpperCase()}`]||"";if(t&&t.required&&!n)throw new Error(`Input required and not supplied: ${e}`);return t&&t.trimWhitespace===!1?n:n.trim()}r.getInput=I;function qe(e,t){return I(e,t).split(`
`).filter(o=>o!=="")}r.getMultilineInput=qe;function Te(e,t){let n=["true","True","TRUE"],o=["false","False","FALSE"],i=I(e,t);if(n.includes(i))return!0;if(o.includes(i))return!1;throw new TypeError(`Input does not meet YAML 1.2 "Core Schema" specification: ${e}
Support boolean input list: \`true | True | TRUE | false | False | FALSE\``)}r.getBooleanInput=Te;function je(e,t){process.stdout.write(C.EOL),c.issueCommand("set-output",{name:e},t)}r.setOutput=je;function De(e){c.issue("echo",e?"on":"off")}r.setCommandEcho=De;function Me(e){process.exitCode=B.Failure,L(e)}r.setFailed=Me;function Re(){return process.env.RUNNER_DEBUG==="1"}r.isDebug=Re;function Fe(e){c.issueCommand("debug",{},e)}r.debug=Fe;function L(e,t={}){c.issueCommand("error",v.toCommandProperties(t),e instanceof Error?e.toString():e)}r.error=L;function Ne(e,t={}){c.issueCommand("warning",v.toCommandProperties(t),e instanceof Error?e.toString():e)}r.warning=Ne;function Ge(e,t={}){c.issueCommand("notice",v.toCommandProperties(t),e instanceof Error?e.toString():e)}r.notice=Ge;function He(e){process.stdout.write(e+C.EOL)}r.info=He;function K(e){c.issue("group",e)}r.startGroup=K;function J(){c.issue("endgroup")}r.endGroup=J;function Ue(e,t){return Ie(this,void 0,void 0,function*(){K(e);let n;try{n=yield t()}finally{J()}return n})}r.group=Ue;function Be(e,t){c.issueCommand("save-state",{name:e},t)}r.saveState=Be;function Le(e){return process.env[`STATE_${e}`]||""}r.getState=Le});var O=l((mt,Y)=>{var d=h(),{execFileSync:Ke}=require("child_process"),$,Je=e=>{$=e},We=e=>S({cmd:"up",args:["--detach",...e],extraEnv:W()}),Ye=()=>S({cmd:"down",extraEnv:W()}),xe=()=>S({cmd:"ps"}),ze=()=>S({cmd:"logs",args:["--no-color","--no-log-prefix"]}),W=()=>({RODE_VERSION:`v${d.getInput("rodeVersion")}`,ELASTICSEARCH_VERSION:d.getInput("elasticsearchVersion"),GRAFEAS_VERSION:`v${d.getInput("grafeasVersion")}`,OPA_VERSION:d.getInput("opaVersion")}),S=({cmd:e,args:t=[],extraEnv:n,log:o=!0})=>{d.startGroup(`docker-compose ${e}`);let i={shell:!1},u=[];$&&u.push("-f",$),u.push(e,...t),n&&(i.env=w(w({},process.env),n));try{let p=Ke("docker-compose",u,i);d.info(p)}finally{d.endGroup()}};Y.exports={configure:Je,up:We,down:Ye,ps:xe,logs:ze}});var z=l((ht,x)=>{var Qe=h(),Xe=["grafeas","elasticsearch","opa"],Ze=()=>{let e=[...Xe];return Qe.getInput("rodeVersion")!=="local"&&e.push("rode"),e};x.exports={getServices:Ze}});var Z=l((gt,X)=>{var b=h(),Q=O(),{getServices:ke}=z(),et={rodeHost:"localhost:50051",opaUrl:"http://localhost:8181",elasticsearchUrl:"http://localhost:9200",grafeasElasticsearchHost:"localhost:8080"},tt=()=>{Object.entries(et).forEach(([e,t])=>{b.setOutput(e,t)})};X.exports=()=>{b.info("Running rode-dev-env main");let e=ke();b.info("Starting services"),Q.up(e),Q.ps(),b.info("Setting outputs"),tt()}});var te=l((_t,ee)=>{var P=h(),k=O();ee.exports=async()=>{P.info("Running rode-dev-env post"),P.info("Dumping logs"),k.logs(),P.info("Stopping services"),k.down()}});var ne=require("fs"),nt=require("path"),g=h(),rt=O(),ot=Z(),it=te(),re="rode-dev-env",A="v0.1.1",oe=`/home/runner/work/_actions/rode/${re}`,st=()=>{if(!process.env.GITHUB_ACTIONS||nt.basename(process.cwd())===re&&ne.existsSync("./docker-compose.yaml"))return;if(!A)throw new Error("Unable to determine action version");g.info(`Appear to be running GitHub Actions with version ${A}`);let t=`${oe}/${A}/docker-compose.yaml`;if(g.info(`Checking if docker compose config is at this path: ${t}`),!ne.existsSync(t))throw new Error(`Expected to find action repository at ${oe}, but wasn't present`);g.info("Found docker compose config"),rt.configure(t)},ct=()=>{let e=g.getState("post");return e||g.saveState("post",!0),e};(async()=>{try{st(),await(ct()?it:ot)()}catch(e){g.setFailed(`Error running rode-dev-env: ${e.stack}`),process.exit(1)}})();
