var ne=Object.defineProperty;var $=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable;var V=(e,t,n)=>t in e?ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,y=(e,t)=>{for(var n in t||(t={}))re.call(t,n)&&V(e,n,t[n]);if($)for(var n of $(t))oe.call(t,n)&&V(e,n,t[n]);return e};var ke=typeof require!="undefined"?require:e=>{throw new Error('Dynamic require of "'+e+'" is not supported')};var f=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var g=f(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.toCommandProperties=m.toCommandValue=void 0;function ie(e){return e==null?"":typeof e=="string"||e instanceof String?e:JSON.stringify(e)}m.toCommandValue=ie;function se(e){return Object.keys(e).length?{title:e.title,line:e.startLine,endLine:e.endLine,col:e.startColumn,endColumn:e.endColumn}:{}}m.toCommandProperties=se});var M=f(s=>{"use strict";var ue=s&&s.__createBinding||(Object.create?function(e,t,n,o){o===void 0&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){o===void 0&&(o=n),e[o]=t[n]}),ce=s&&s.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),ae=s&&s.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!=="default"&&Object.hasOwnProperty.call(e,n)&&ue(t,e,n);return ce(t,e),t};Object.defineProperty(s,"__esModule",{value:!0});s.issue=s.issueCommand=void 0;var le=ae(require("os")),j=g();function q(e,t,n){let o=new T(e,t,n);process.stdout.write(o.toString()+le.EOL)}s.issueCommand=q;function fe(e,t=""){q(e,{},t)}s.issue=fe;var A="::",T=class{constructor(t,n,o){t||(t="missing.command"),this.command=t,this.properties=n,this.message=o}toString(){let t=A+this.command;if(this.properties&&Object.keys(this.properties).length>0){t+=" ";let n=!0;for(let o in this.properties)if(this.properties.hasOwnProperty(o)){let i=this.properties[o];i&&(n?n=!1:t+=",",t+=`${o}=${pe(i)}`)}}return t+=`${A}${de(this.message)}`,t}};function de(e){return j.toCommandValue(e).replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A")}function pe(e){return j.toCommandValue(e).replace(/%/g,"%25").replace(/\r/g,"%0D").replace(/\n/g,"%0A").replace(/:/g,"%3A").replace(/,/g,"%2C")}});var F=f(a=>{"use strict";var me=a&&a.__createBinding||(Object.create?function(e,t,n,o){o===void 0&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){o===void 0&&(o=n),e[o]=t[n]}),he=a&&a.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),D=a&&a.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!=="default"&&Object.hasOwnProperty.call(e,n)&&me(t,e,n);return he(t,e),t};Object.defineProperty(a,"__esModule",{value:!0});a.issueCommand=void 0;var G=D(require("fs")),ge=D(require("os")),_e=g();function ve(e,t){let n=process.env[`GITHUB_${e}`];if(!n)throw new Error(`Unable to find environment variable for file command ${e}`);if(!G.existsSync(n))throw new Error(`Missing file at path: ${n}`);G.appendFileSync(n,`${_e.toCommandValue(t)}${ge.EOL}`,{encoding:"utf8"})}a.issueCommand=ve});var h=f(r=>{"use strict";var Ce=r&&r.__createBinding||(Object.create?function(e,t,n,o){o===void 0&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){o===void 0&&(o=n),e[o]=t[n]}),Se=r&&r.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),R=r&&r.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n in e)n!=="default"&&Object.hasOwnProperty.call(e,n)&&Ce(t,e,n);return Se(t,e),t},Oe=r&&r.__awaiter||function(e,t,n,o){function i(c){return c instanceof n?c:new n(function(l){l(c)})}return new(n||(n=Promise))(function(c,l){function O(p){try{b(o.next(p))}catch(E){l(E)}}function te(p){try{b(o.throw(p))}catch(E){l(E)}}function b(p){p.done?c(p.value):i(p.value).then(O,te)}b((o=o.apply(e,t||[])).next())})};Object.defineProperty(r,"__esModule",{value:!0});r.getState=r.saveState=r.group=r.endGroup=r.startGroup=r.info=r.notice=r.warning=r.error=r.debug=r.isDebug=r.setFailed=r.setCommandEcho=r.setOutput=r.getBooleanInput=r.getMultilineInput=r.getInput=r.addPath=r.setSecret=r.exportVariable=r.ExitCode=void 0;var u=M(),B=F(),_=g(),v=R(require("os")),be=R(require("path")),H;(function(e){e[e.Success=0]="Success",e[e.Failure=1]="Failure"})(H=r.ExitCode||(r.ExitCode={}));function Ee(e,t){let n=_.toCommandValue(t);if(process.env[e]=n,process.env.GITHUB_ENV||""){let i="_GitHubActionsFileCommandDelimeter_",c=`${e}<<${i}${v.EOL}${n}${v.EOL}${i}`;B.issueCommand("ENV",c)}else u.issueCommand("set-env",{name:e},n)}r.exportVariable=Ee;function ye(e){u.issueCommand("add-mask",{},e)}r.setSecret=ye;function we(e){process.env.GITHUB_PATH||""?B.issueCommand("PATH",e):u.issueCommand("add-path",{},e),process.env.PATH=`${e}${be.delimiter}${process.env.PATH}`}r.addPath=we;function w(e,t){let n=process.env[`INPUT_${e.replace(/ /g,"_").toUpperCase()}`]||"";if(t&&t.required&&!n)throw new Error(`Input required and not supplied: ${e}`);return t&&t.trimWhitespace===!1?n:n.trim()}r.getInput=w;function Ie(e,t){return w(e,t).split(`
`).filter(o=>o!=="")}r.getMultilineInput=Ie;function Pe(e,t){let n=["true","True","TRUE"],o=["false","False","FALSE"],i=w(e,t);if(n.includes(i))return!0;if(o.includes(i))return!1;throw new TypeError(`Input does not meet YAML 1.2 "Core Schema" specification: ${e}
Support boolean input list: \`true | True | TRUE | false | False | FALSE\``)}r.getBooleanInput=Pe;function $e(e,t){process.stdout.write(v.EOL),u.issueCommand("set-output",{name:e},t)}r.setOutput=$e;function Ve(e){u.issue("echo",e?"on":"off")}r.setCommandEcho=Ve;function je(e){process.exitCode=H.Failure,L(e)}r.setFailed=je;function qe(){return process.env.RUNNER_DEBUG==="1"}r.isDebug=qe;function Ae(e){u.issueCommand("debug",{},e)}r.debug=Ae;function L(e,t={}){u.issueCommand("error",_.toCommandProperties(t),e instanceof Error?e.toString():e)}r.error=L;function Te(e,t={}){u.issueCommand("warning",_.toCommandProperties(t),e instanceof Error?e.toString():e)}r.warning=Te;function Me(e,t={}){u.issueCommand("notice",_.toCommandProperties(t),e instanceof Error?e.toString():e)}r.notice=Me;function De(e){process.stdout.write(e+v.EOL)}r.info=De;function U(e){u.issue("group",e)}r.startGroup=U;function N(){u.issue("endgroup")}r.endGroup=N;function Ge(e,t){return Oe(this,void 0,void 0,function*(){U(e);let n;try{n=yield t()}finally{N()}return n})}r.group=Ge;function Fe(e,t){u.issueCommand("save-state",{name:e},t)}r.saveState=Fe;function Re(e){return process.env[`STATE_${e}`]||""}r.getState=Re});var I=f((it,W)=>{var d=h(),Be=require("path"),{execFileSync:He}=require("child_process"),Le=e=>C({cmd:"up",args:["--detach",...e],extraEnv:J()}),Ue=()=>C({cmd:"down",extraEnv:J()}),Ne=()=>C({cmd:"ps"}),Je=()=>C({cmd:"logs",args:["--no-color","--no-log-prefix"]}),J=()=>({RODE_VERSION:`v${d.getInput("rodeVersion")}`,ELASTICSEARCH_VERSION:d.getInput("elasticsearchVersion"),GRAFEAS_VERSION:`v${d.getInput("grafeasVersion")}`,OPA_VERSION:d.getInput("opaVersion")}),C=({cmd:e,args:t=[],extraEnv:n,log:o=!0})=>{d.startGroup(`docker-compose ${e}`);let i={shell:!1},c=[],l=process.env.GITHUB_ACTION_PATH;l&&(d.info(`Running from ${l}`),c.push("-f",Be.join(l,"docker-compose.yaml"))),c.push(e,...t),n&&(i.env=y(y({},process.env),n));try{let O=He("docker-compose",c,i);d.info(O)}finally{d.endGroup()}};W.exports={up:Le,down:Ue,ps:Ne,logs:Je}});var z=f((st,Y)=>{var We=h(),Ye=["grafeas","elasticsearch","opa"],ze=()=>{let e=[...Ye];return We.getInput("rodeVersion")!=="local"&&e.push("rode"),e};Y.exports={getServices:ze}});var X=f((ut,Q)=>{var S=h(),K=I(),{getServices:Ke}=z(),Qe={rodeHost:"localhost:50051",opaUrl:"http://localhost:8181",elasticsearchUrl:"http://localhost:9200",grafeasElasticsearchHost:"localhost:8080"},Xe=()=>{Object.entries(Qe).forEach(([e,t])=>{S.setOutput(e,t)})};Q.exports=()=>{S.info("Running rode-dev-env main");let e=Ke();S.info("Starting services"),K.up(e),K.ps(),S.info("Setting outputs"),Xe()}});var k=f((ct,x)=>{var P=h(),Z=I();x.exports=async()=>{P.info("Running rode-dev-env post"),P.info("Dumping logs"),Z.logs(),P.info("Stopping services"),Z.down()}});var ee=h(),Ze=X(),xe=k();(async()=>{try{await(ee.getInput("stage")==="post"?xe:Ze)()}catch(e){ee.setFailed(`Error running rode-dev-env: ${e.stack}`),process.exit(1)}})();
